---
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import { render, getEntries } from "astro:content";
import DifficultyAccordion from "@/layouts/helpers/DifficultyAccordion.astro";
import ExplorerSidebar from "@/layouts/helpers/ExplorerSidebar.astro";
import Breadcrumbs from "@/layouts/helpers/Breadcrumbs.astro";
import LiteYouTubeEmbed from "react-lite-youtube-embed";
import "react-lite-youtube-embed/dist/LiteYouTubeEmbed.css";

export async function getStaticPaths() {
  const moves = await getSinglePage("moves");
  return moves.map((move) => ({
    params: { slug: move.id },
    props: { move },
  }));
}

const { move } = Astro.props;
const { Content } = await render(move);
const {
  title,
  type,
  level,
  difficulty,
  leader_difficulty,
  follower_difficulty,
  video_url,
  related_concepts,
  setup_moves,
  exit_moves,
  related_moves,
  tags,
} = move.data;

// Helper to extract YouTube ID
const getYoutubeId = (url: string | undefined) => {
  if (!url) return null;
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return match && match[2].length === 11 ? match[2] : null;
};

const videoId = getYoutubeId(video_url);

// Resolve references
const resolvedRelatedConcepts = related_concepts ? await getEntries(related_concepts) : [];
const resolvedSetupMoves = setup_moves ? await getEntries(setup_moves) : [];
const resolvedExitMoves = exit_moves ? await getEntries(exit_moves) : [];
const resolvedRelatedMoves = related_moves ? await getEntries(related_moves) : [];
---

<Base title={title}>
  <section class="section pt-7">
    <div class="container">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        {/* Sidebar (Left on Desktop, Bottom on Mobile) */}
        <div class="lg:col-span-3 order-2 lg:order-1">
          <div class="lg:sticky lg:top-24 h-auto lg:h-[calc(100vh-8rem)]">
            <ExplorerSidebar
              setupMoves={resolvedSetupMoves}
              relatedMoves={resolvedRelatedMoves}
              exitMoves={resolvedExitMoves}
              relatedConcepts={resolvedRelatedConcepts}
            />
          </div>
        </div>

        {/* Main Content (Right on Desktop, Top on Mobile) */}
        <article class="lg:col-span-9 order-1 lg:order-2">
          {/* Header */}
          <div class="mb-4">
            <Breadcrumbs
              className="mb-4"
              parts={[
                { label: "Home", href: "/" },
                { label: "Moves", href: "/moves" },
                { label: title },
              ]}
            />
            <div class="flex items-center gap-3 mb-4">
              <span
                class={`px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider ${
                  level === "beginner"
                    ? "bg-level-beginner/10 text-level-beginner dark:bg-darkmode-level-beginner/10 dark:text-darkmode-level-beginner"
                    : level === "intermediate"
                      ? "bg-level-intermediate/10 text-level-intermediate dark:bg-darkmode-level-intermediate/10 dark:text-darkmode-level-intermediate"
                      : "bg-level-advanced/10 text-level-advanced dark:bg-darkmode-level-advanced/10 dark:text-darkmode-level-advanced"
                }`}
              >
                {level}
              </span>
              <span
                class="px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-sm font-bold uppercase tracking-wider dark:bg-gray-700 dark:text-gray-200"
              >
                {type}
              </span>
            </div>
            <h1 class="h1">
              {title}
            </h1>
          </div>

          {/* Difficulty Accordion */}
          <DifficultyAccordion
            leaderDifficulty={leader_difficulty}
            followerDifficulty={follower_difficulty}
            overallDifficulty={difficulty}
          />

          {/* Content */}
          <div
            class="content mb-10 prose-a:text-accent prose-a:no-underline hover:prose-a:underline"
          >
            <Content />
          </div>
          {/* Video */}
          {
            videoId && (
              <div class="mb-10 rounded-lg overflow-hidden shadow-lg">
                <LiteYouTubeEmbed client:idle id={videoId} title={title} poster="maxresdefault" />
              </div>
            )
          }
        </article>
      </div>
    </div>
  </section>
</Base>
