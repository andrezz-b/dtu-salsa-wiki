---
import { getSinglePage } from "@/lib/contentParser.astro";
import { render, getEntries } from "astro:content";
import DifficultyAccordion from "@/layouts/helpers/DifficultyAccordion.astro";
import { getYoutubeId } from "@/lib/utils/video";
import ContentLayout from "@/layouts/ContentLayout.astro";

export async function getStaticPaths() {
  const moves = await getSinglePage("moves");
  const concepts = await getSinglePage("concepts");

  return moves.map((move) => {
    const usedInMoves = moves.filter((m) => {
      const checkRef = (refs: any[] | undefined) =>
        refs?.some((r) =>
          typeof r === "string" ? r === move.id : r.id === move.id,
        );
      return (
        checkRef(m.data.setup_moves) ||
        checkRef(m.data.exit_moves) ||
        checkRef(m.data.related_moves)
      );
    });

    const usedInConcepts = concepts.filter((c) => {
      const checkRef = (refs: any[] | undefined) =>
        refs?.some((r) =>
          typeof r === "string" ? r === move.id : r.id === move.id,
        );
      return checkRef(c.data.related_moves);
    });

    return {
      params: { slug: move.id },
      props: { move, usedInMoves, usedInConcepts },
    };
  });
}

const { move, usedInMoves, usedInConcepts } = Astro.props;
const { Content } = await render(move);
const {
  title,
  type,
  level,
  difficulty,
  leader_difficulty,
  follower_difficulty,
  video_urls,
  related_concepts,
  setup_moves,
  exit_moves,
  related_moves,
  aliases,
} = move.data;

const videoIds = video_urls
  ? video_urls.map((url) => getYoutubeId(url)).filter((id) => id !== null)
  : [];

// Resolve references
const resolvedRelatedConcepts = related_concepts
  ? await getEntries(related_concepts)
  : [];
const resolvedSetupMoves = setup_moves ? await getEntries(setup_moves) : [];
const resolvedExitMoves = exit_moves ? await getEntries(exit_moves) : [];
const resolvedRelatedMoves = related_moves
  ? await getEntries(related_moves)
  : [];
---

<ContentLayout
  title={title}
  type={type}
  level={level}
  videoIds={videoIds}
  breadcrumbs={[
    { label: "Home", href: "/" },
    { label: "Moves", href: "/moves" },
    { label: title },
  ]}
  sidebarProps={{
    setupMoves: resolvedSetupMoves,
    relatedMoves: resolvedRelatedMoves,
    exitMoves: resolvedExitMoves,
    relatedConcepts: resolvedRelatedConcepts,
    usedInMoves: usedInMoves,
    usedInConcepts: usedInConcepts,
  }}
>
  <div slot="header-bottom" class="flex flex-row items-start gap-4 mt-2">
    <DifficultyAccordion
      leaderDifficulty={leader_difficulty}
      followerDifficulty={follower_difficulty}
      overallDifficulty={difficulty}
    />
    {
      aliases && aliases.length > 0 && (
        <div class="flex flex-col gap-1 p-2">
          <span class="text-gray-500 text-xs uppercase tracking-wider font-medium">
            Also known as
          </span>
          <div class="flex flex-wrap gap-1.5">
            {aliases.map((alias) => (
              <span class="px-2 py-0.5 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm">
                {alias}
              </span>
            ))}
          </div>
        </div>
      )
    }
  </div>

  <Content />
</ContentLayout>
