---
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import { render, getEntries } from "astro:content";
import DifficultyAccordion from "@/layouts/helpers/DifficultyAccordion.astro";
import ExplorerSidebar from "@/layouts/helpers/ExplorerSidebar.astro";
import Breadcrumbs from "@/layouts/helpers/Breadcrumbs";
import LiteYouTubeEmbed from "react-lite-youtube-embed";
import "react-lite-youtube-embed/dist/LiteYouTubeEmbed.css";
import { getYoutubeId } from "@/lib/utils/video";

export async function getStaticPaths() {
  const moves = await getSinglePage("moves");
  const concepts = await getSinglePage("concepts");

  return moves.map((move) => {
    const usedInMoves = moves.filter((m) => {
      const checkRef = (refs: any[] | undefined) =>
        refs?.some((r) =>
          typeof r === "string" ? r === move.id : r.id === move.id,
        );
      return (
        checkRef(m.data.setup_moves) ||
        checkRef(m.data.exit_moves) ||
        checkRef(m.data.related_moves)
      );
    });

    const usedInConcepts = concepts.filter((c) => {
      const checkRef = (refs: any[] | undefined) =>
        refs?.some((r) =>
          typeof r === "string" ? r === move.id : r.id === move.id,
        );
      return checkRef(c.data.related_moves);
    });

    return {
      params: { slug: move.id },
      props: { move, usedInMoves, usedInConcepts },
    };
  });
}

const { move, usedInMoves, usedInConcepts } = Astro.props;
const { Content } = await render(move);
const {
  title,
  type,
  level,
  difficulty,
  leader_difficulty,
  follower_difficulty,
  video_urls,
  related_concepts,
  setup_moves,
  exit_moves,
  related_moves,
  tags,
  aliases,
} = move.data;

const pageUrl = Astro.url.href;

const videoIds = video_urls
  ? video_urls.map((url) => getYoutubeId(url)).filter((id) => id !== null)
  : [];

// Resolve references
const resolvedRelatedConcepts = related_concepts
  ? await getEntries(related_concepts)
  : [];
const resolvedSetupMoves = setup_moves ? await getEntries(setup_moves) : [];
const resolvedExitMoves = exit_moves ? await getEntries(exit_moves) : [];
const resolvedRelatedMoves = related_moves
  ? await getEntries(related_moves)
  : [];
---

<Base title={title}>
  <section class="section pt-6">
    <div class="container">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        {/* Sidebar (Left on Desktop, Bottom on Mobile) */}
        <div class="lg:col-span-3 order-2 lg:order-1">
          <div class="h-auto">
            <ExplorerSidebar
              setupMoves={resolvedSetupMoves}
              relatedMoves={resolvedRelatedMoves}
              exitMoves={resolvedExitMoves}
              relatedConcepts={resolvedRelatedConcepts}
              usedInMoves={usedInMoves}
              usedInConcepts={usedInConcepts}
            />
          </div>
        </div>

        {/* Main Content (Right on Desktop, Top on Mobile) */}
        <article class="lg:col-span-9 order-1 lg:order-2">
          {/* Header */}
          <div class="mb-6">
            <Breadcrumbs
              className="mb-4"
              parts={[
                { label: "Home", href: "/" },
                { label: "Moves", href: "/moves" },
                { label: title },
              ]}
            />
            <div class="flex items-center gap-3 mb-3">
              <span
                class={`px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider ${
                  level === "beginner"
                    ? "bg-level-beginner/10 text-level-beginner dark:bg-darkmode-level-beginner/10 dark:text-darkmode-level-beginner"
                    : level === "intermediate"
                      ? "bg-level-intermediate/10 text-level-intermediate dark:bg-darkmode-level-intermediate/10 dark:text-darkmode-level-intermediate"
                      : "bg-level-advanced/10 text-level-advanced dark:bg-darkmode-level-advanced/10 dark:text-darkmode-level-advanced"
                }`}
              >
                {level}
              </span>
              <span
                class="px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-sm font-bold uppercase tracking-wider dark:bg-gray-700 dark:text-gray-200"
              >
                {type}
              </span>
            </div>
            <div class="block">
              <h1 class="h1">
                {title}
                <button
                  id="copy-link-btn"
                  class="inline-block p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors"
                  title="Copy link to clipboard"
                  data-url={pageUrl}
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-5 h-5 text-gray-600 dark:text-gray-300"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                    ></path>
                  </svg>
                </button>
              </h1>

              <div class="flex flex-row items-start gap-4 mt-2">
                <DifficultyAccordion
                  leaderDifficulty={leader_difficulty}
                  followerDifficulty={follower_difficulty}
                  overallDifficulty={difficulty}
                />
                {
                  aliases && aliases.length > 0 && (
                    <div class="flex flex-col gap-1 p-2">
                      <span class="text-gray-500 text-xs uppercase tracking-wider font-medium">
                        Also known as
                      </span>
                      <div class="flex flex-wrap gap-1.5">
                        {aliases.map((alias) => (
                          <span class="px-2 py-0.5 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm">
                            {alias}
                          </span>
                        ))}
                      </div>
                    </div>
                  )
                }
              </div>
            </div>
          </div>

          {/* Videos */}
          {
            videoIds.length > 0 && (
              <div class="grid grid-cols-1 gap-6 mb-10">
                {videoIds.map((id) => (
                  <div class="rounded-lg overflow-hidden shadow-lg">
                    <LiteYouTubeEmbed
                      client:idle
                      id={id}
                      title={title}
                      webp={true}
                      params="rel=0"
                      rel="preload"
                    />
                  </div>
                ))}
              </div>
            )
          }

          {/* Content */}
          <div
            class="content mb-10 prose-a:text-accent prose-a:no-underline prose-a:hover:underline"
          >
            <Content />
          </div>
        </article>
      </div>
    </div>
  </section>
</Base>

<script>
  const copyBtn = document.getElementById("copy-link-btn");
  if (copyBtn) {
    copyBtn.addEventListener("click", async () => {
      const url = copyBtn.getAttribute("data-url") || window.location.href;
      try {
        await navigator.clipboard.writeText(url);
        copyBtn.classList.add("!bg-green-100", "dark:!bg-green-700");
        setTimeout(() => {
          copyBtn.classList.remove("!bg-green-100", "dark:!bg-green-700");
        }, 1000);
      } catch (err) {
        console.error("Failed to copy link:", err);
      }
    });
  }
</script>
