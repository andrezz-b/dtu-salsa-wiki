---
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import { humanize, markdownify } from "@/lib/utils/textConverter";
import { render } from "astro:content";
import LiteYouTubeEmbed from "react-lite-youtube-embed";
import "react-lite-youtube-embed/dist/LiteYouTubeEmbed.css";

export async function getStaticPaths() {
  const concepts = await getSinglePage("concepts");
  return concepts.map((concept) => ({
    params: { slug: concept.id },
    props: { concept },
  }));
}

const { concept } = Astro.props;
const { Content } = await render(concept);
const { title, type, level, video_url, related_concepts, related_moves } =
  concept.data;

// Fetch all moves to find references
const allMoves = await getSinglePage("moves");
const usedInMoves = allMoves.filter((move) =>
  move.data.related_concepts?.includes(title),
);

// Helper to extract YouTube ID
const getYoutubeId = (url: string) => {
  if (!url) return null;
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return match && match[2].length === 11 ? match[2] : null;
};

const videoId = getYoutubeId(video_url);
---

<Base title={title}>
  <section class="section pt-7">
    <div class="container">
      <div class="row justify-center">
        <article class="lg:col-10">
          {/* Header */}
          <div class="mb-8 text-center">
            <div class="flex items-center justify-center gap-3 mb-4">
              <span
                class={`px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider ${
                  level === "beginner"
                    ? "bg-green-100 text-green-800"
                    : level === "intermediate"
                      ? "bg-yellow-100 text-yellow-800"
                      : "bg-red-100 text-red-800"
                }`}
              >
                {level}
              </span>
              <span
                class="px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-sm font-bold uppercase tracking-wider dark:bg-gray-700 dark:text-gray-200"
              >
                {type}
              </span>
            </div>
            <h1 set:html={markdownify(title)} class="h2 mb-4" />
          </div>

          {/* Video */}
          {
            videoId && (
              <div class="mb-10 rounded-lg overflow-hidden shadow-lg">
                <LiteYouTubeEmbed
                  id={videoId}
                  title={title}
                  poster="maxresdefault"
                />
              </div>
            )
          }

          {/* Content */}
          <div class="content mb-10">
            <Content />
          </div>

          {/* Relations */}
          <div
            class="bg-theme-light dark:bg-darkmode-theme-light p-6 rounded-lg"
          >
            <h3 class="h5 mb-4">Related Content</h3>
            <div class="grid md:grid-cols-2 gap-6">
              {/* Used In Moves (Reverse Lookup) */}
              {
                usedInMoves.length > 0 && (
                  <div>
                    <h4 class="h6 mb-2 text-gray-500">Used In Moves</h4>
                    <ul class="list-disc pl-5">
                      {usedInMoves.map((move) => (
                        <li>
                          <a
                            href={`/moves/${move.id}`}
                            class="text-primary hover:underline"
                          >
                            {move.data.title}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                )
              }

              {
                related_moves && related_moves.length > 0 && (
                  <div>
                    <h4 class="h6 mb-2 text-gray-500">Related Moves</h4>
                    <ul class="list-disc pl-5">
                      {related_moves.map((m: string) => (
                        <li>
                          <a
                            href={`/moves/${m}`}
                            class="text-primary hover:underline"
                          >
                            {humanize(m)}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                )
              }

              {
                related_concepts && related_concepts.length > 0 && (
                  <div>
                    <h4 class="h6 mb-2 text-gray-500">Related Concepts</h4>
                    <ul class="list-disc pl-5">
                      {related_concepts.map((c: string) => (
                        <li>
                          <a
                            href={`/concepts/${c}`}
                            class="text-primary hover:underline"
                          >
                            {humanize(c)}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                )
              }
            </div>
          </div>
        </article>
      </div>
    </div>
  </section>
</Base>
