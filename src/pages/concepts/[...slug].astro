---
import { getSinglePage } from "@/lib/contentParser.astro";
import { render, getEntries } from "astro:content";
import { getYoutubeId } from "@/lib/utils/video";
import ContentLayout from "@/layouts/ContentLayout.astro";

export async function getStaticPaths() {
  const concepts = await getSinglePage("concepts");
  const moves = await getSinglePage("moves");

  return concepts.map((concept) => {
    const usedInMoves = moves.filter((m) => {
      const checkRef = (refs: (string | { id: string })[] | undefined) =>
        refs?.some((r) =>
          typeof r === "string" ? r === concept.id : r.id === concept.id,
        );
      return checkRef(m.data.related_concepts);
    });

    const usedInConcepts = concepts.filter((c) => {
      const checkRef = (refs: (string | { id: string })[] | undefined) =>
        refs?.some((r) =>
          typeof r === "string" ? r === concept.id : r.id === concept.id,
        );
      return checkRef(c.data.related_concepts);
    });

    return {
      params: { slug: concept.id },
      props: { concept, usedInMoves, usedInConcepts },
    };
  });
}

const { concept, usedInMoves, usedInConcepts } = Astro.props;
const { Content } = await render(concept);
const { title, type, level, video_urls, related_concepts, related_moves } =
  concept.data;

const videoIds = video_urls
  ? video_urls.map((url) => getYoutubeId(url)).filter((id) => id !== null)
  : [];

const resolvedRelatedMoves = related_moves
  ? await getEntries(related_moves)
  : [];
const resolvedRelatedConcepts = related_concepts
  ? await getEntries(related_concepts)
  : [];
---

<ContentLayout
  title={title}
  type={type}
  level={level}
  videoIds={videoIds}
  breadcrumbs={[
    { label: "Home", href: "/" },
    { label: "Concepts", href: "/concepts" },
    { label: title },
  ]}
  sidebarProps={{
    relatedMoves: resolvedRelatedMoves,
    relatedConcepts: resolvedRelatedConcepts,
    usedInMoves: usedInMoves,
    usedInConcepts: usedInConcepts,
  }}
>
  <Content />
</ContentLayout>
