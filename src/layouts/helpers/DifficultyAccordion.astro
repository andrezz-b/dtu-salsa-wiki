---
import { FaChevronRight } from "react-icons/fa";
import StarRatingDisplay from "@/components/ui/StarRatingDisplay";

interface Props {
  leaderDifficulty?: number;
  followerDifficulty?: number;
  overallDifficulty: number;
}

const { leaderDifficulty, followerDifficulty, overallDifficulty } = Astro.props;
const hasBreakdown =
  leaderDifficulty !== undefined || followerDifficulty !== undefined;
---

<div class="difficulty-accordion flex flex-wrap items-center gap-4">
  <button
    class={`accordion-trigger flex flex-col items-start gap-1 p-2 rounded-lg transition-colors ${
      hasBreakdown
        ? "cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5"
        : "cursor-default"
    }`}
    aria-expanded="false"
    disabled={!hasBreakdown}
  >
    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider"
      >Difficulty</span
    >
    <div class="flex items-center gap-2">
      <StarRatingDisplay rating={overallDifficulty} />
      {
        hasBreakdown && (
          <span class="icon-chevron text-gray-400 text-xs transition-transform duration-200">
            <FaChevronRight />
          </span>
        )
      }
    </div>
  </button>

  {
    hasBreakdown && (
      <div class="difficulty-content hidden flex flex-row items-center gap-6 pl-4 border-l border-border dark:border-darkmode-border">
        {/* Leader Difficulty */}
        <div class="flex flex-col items-start gap-1">
          <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">
            Leader
          </span>
          <StarRatingDisplay
            rating={leaderDifficulty || overallDifficulty}
            color="text-blue-500"
          />
        </div>

        {/* Follower Difficulty */}
        <div class="flex flex-col items-start gap-1">
          <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">
            Follower
          </span>
          <StarRatingDisplay
            rating={followerDifficulty || overallDifficulty}
            color="text-pink-500"
          />
        </div>
      </div>
    )
  }
</div>

<script>
  function setupAccordions() {
    const accordions = document.querySelectorAll(".difficulty-accordion");

    accordions.forEach((accordion) => {
      const trigger = accordion.querySelector(".accordion-trigger");

      // Skip if already initialized or disabled
      if (
        !trigger ||
        trigger.hasAttribute("disabled") ||
        trigger.hasAttribute("data-initialized")
      ) {
        return;
      }

      // Mark as initialized
      trigger.setAttribute("data-initialized", "true");

      trigger.addEventListener("click", () => {
        const content = accordion.querySelector(".difficulty-content");
        const icon = trigger.querySelector(".icon-chevron");

        if (!content) {
          return;
        }

        const isExpanded = trigger.getAttribute("aria-expanded") === "true";
        trigger.setAttribute("aria-expanded", (!isExpanded).toString());

        // Toggle visibility
        content.classList.toggle("hidden");

        // Rotate icon
        if (icon) {
          if (!isExpanded) {
            icon.classList.add("rotate-90");
          } else {
            icon.classList.remove("rotate-90");
          }
        }
      });
    });
  }

  // Run on initial load
  setupAccordions();

  // Run on view transitions navigation
  document.addEventListener("astro:page-load", setupAccordions);
</script>
